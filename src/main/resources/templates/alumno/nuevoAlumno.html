<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="/plantilla/plantillaui.html">
<head>
<title>Nuevo Alumno</title>
</head>

<!--begin::Body-->
<body>
	<div layout:fragment="contenidopaginas">

		<div class="card card-info card-outline mb-4">
			<!--begin::Header-->
			<div class="card-header">
				<div class="card-title">INGRESAR NUEVO ALUMNO</div>
			</div>
			<!--end::Header-->

			<!--begin::Form-->
			<form th:action="@{/alumnos}" th:object="${modelAlumno}"
				method="post" class="needs-validation" novalidate>
				<!--begin::Body-->
				<div class="card-body">
					<!-- Mensaje de error proveniente del servidor -->
					<div th:if="${fechaError}" class="alert alert-danger"
						th:text="${fechaError}"></div>
					<!--begin::Row-->
					<div class="row g-3">
					
							<input type="hidden" class="form-control" id="txtidAlumno"
								th:field="*{alu_id}"/>

						<!-- Nombres (ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom01" class="form-label">Nombres:*</label>
							<input type="text" class="form-control" id="txtnombrealumno"
								th:field="*{alu_nombre}" required />
							<!-- Feedback para Nombres -->
							<div class="invalid-feedback">Por favor ingrese los nombres.</div>
						</div>

						<!-- Apellidos (ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Apellidos:*</label>
							<input type="text" class="form-control" id="txtapellidoalumno"
								required th:field="*{alu_apellido}" />
							<!-- Feedback para Apellidos -->
							<div class="invalid-feedback">Por favor ingrese los apellidos.</div>
						</div>

						<!-- cedeula (ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Cedula:*</label>
							<input type="text" inputmode="numeric" class="form-control" id="txtcedeulaalumno"
								th:field="*{alu_cedula}" maxlength="10" minlength="10"
								pattern="[0-9]{10}" required />
							<!-- Mensaje de error de cédula (server-side) -->
							<div th:if="${cedulaError}" class="invalid-feedback d-block"
								th:text="${cedulaError}"></div>
							<!-- Mensaje de validación cliente -->
							<div id="cedulaFeedback" class="invalid-feedback" style="display: none"></div>
						</div>

						<!--  email(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Email:*</label>
							<input type="email" class="form-control" id="txtemailalumno"
								th:field="*{alu_email}" placeholder="correo@ejemplo.com"
								required />
							<!-- Feedback para Email -->
							<div class="invalid-feedback">Ingrese un email válido.</div>
						</div>

						<!--  direccion(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Domicilio:*</label>
							<input type="text" class="form-control" id="txtdireccionalumno"
								th:field="*{alu_direccion}" required />
							<!-- Feedback para Domicilio -->
							<div class="invalid-feedback">Ingrese la dirección.</div>
						</div>

						<!--  telefono(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Teléfono:*</label>
							<input type="text" inputmode="numeric" class="form-control" id="txttelefonolumno"
								pattern="[0-9]{10}" maxlength="10" th:field="*{alu_telefono}" required />
							<!-- Feedback para Teléfono -->
							<div id="telefonoAlumnoFeedback" class="invalid-feedback">Ingrese un teléfono válido de 10 dígitos.</div>
						</div>


						<!--  nacimiento(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Fecha
								de Nacimiento:*</label> <input type="date" class="form-control"
								id="fechaNacimiento" th:field="*{alu_fecha_nacimiento}" required />
							<!-- Feedback para Fecha de nacimiento -->
							<div id="fechaNacimientoFeedback" class="invalid-feedback">El alumno debe tener al menos 4 años.</div>

						</div>


						<!--  ingreso(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Fecha
								de Ingreso:*</label> <input type="date" class="form-control"
								id="fechaIngreso" th:field="*{alu_fecha_ingreso}" required />
							<!-- Feedback para Fecha de ingreso -->
							<div class="invalid-feedback">Seleccione una fecha de ingreso válida (no futura).</div>
						</div>


						<!--  nombre representante(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Nombre
								de Representante:</label> <input type="text" class="form-control"
								id="txtNombreRepresentante" th:field="*{alu_nombre_representante}" />
							<!-- Feedback para Nombre de representante -->
							<div class="invalid-feedback">Ingrese el nombre del representante si aplica.</div>
						</div>

						<!--  telefono representante(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Telefono
								de Representante:</label> <input type="text" inputmode="numeric" class="form-control"
								id="txtTelefonoRepresentante" maxlength="10" pattern="[0-9]{10}" th:field="*{alu_telefono_representante}" />
							<!-- Feedback para Telefono de representante -->
							<div id="telefonoRepresentanteFeedback" class="invalid-feedback">Ingrese el teléfono del representante (10 dígitos) si aplica.</div>
						</div>

						<!-- Mensaje de error del representante (server-side) -->
						<div class="col-12">
							<div th:if="${representanteError}" class="invalid-feedback d-block"
								th:text="${representanteError}"></div>
						</div>

						<!--  nombre representante(ejemplo) -->

						<!-- Cinturon de ingreso -->
						<div class="col-md-6">
							<label for="cmbCinturonIngreso" class="form-label">Cinturón
								de Ingreso:*</label> <select class="form-select" id="cmbCinturonIngreso"
								th:field="*{alu_cinturon_ingreso}" required>

								<option value="">Seleccione...</option>
								<!-- Renderizamos las opciones desde el enum pasado en el modelo -->
								<th:block th:each="cinturon : ${cinturones}">
									<option th:value="${cinturon.name()}"
										th:text="${cinturon.nombre}"></option>
								</th:block>
							</select>
							<div class="invalid-feedback">Seleccione un cinturón de ingreso.</div>
						</div>

						<!-- Cinturon de ingreso -->
						<div class="col-md-6">
							<label for="cmbCinturonActual" class="form-label">Cinturón
								Actual:*</label> <select class="form-select" id="cmbCinturonActual"
								th:field="*{alu_cinturon_actual}" required>

								<option value="">Seleccione...</option>
								<!-- Renderizamos las opciones desde el enum pasado en el modelo -->
								<th:block th:each="cinturon : ${cinturones}">
									<option th:value="${cinturon.name()}"
										th:text="${cinturon.nombre}"></option>
								</th:block>
							</select>
							<div class="invalid-feedback">Seleccione un cinturón actual válido.</div>
						</div>

						<div class="col-md-6 form-check mt-4">
							<input type="checkbox" class="form-check-input" id="estado"
								th:field="*{alu_estado}" value="A" required> <label
								class="form-check-label" for="estado"> Activo </label>
						</div>
					</div>
					<!--end::Row-->

					<!-- Feedback para validación de cinturones -->
					<div class="col-12">
						<div id="cinturonFeedback" class="invalid-feedback d-block" style="display: none"></div>
					</div>
				</div>
				<!--end::Body-->

				<!--begin::Footer-->
				<div class="card-footer">
					<button type="submit" class="btn btn-primary">Guardar</button>
				</div>
				<!--end::Footer-->
			</form>
			<!--end::Form-->

			<!--begin::JavaScript-->
			<script>
			// Validación: la fecha de nacimiento máxima permitida es hoy - 4 años
			(function () {
				'use strict';
				// Calcula la fecha máxima (YYYY-MM-DD) restando 4 años a la fecha actual
				function fechaMaximaMenosAnios(anios) {
					const hoy = new Date();
					const max = new Date(hoy.getFullYear() - anios, hoy.getMonth(), hoy.getDate());
					const yy = max.getFullYear();
					const mm = String(max.getMonth() + 1).padStart(2, '0');
					const dd = String(max.getDate()).padStart(2, '0');
					return `${yy}-${mm}-${dd}`;
				}

				function hoyString() {
					const hoy = new Date();
					const yy = hoy.getFullYear();
					const mm = String(hoy.getMonth() + 1).padStart(2, '0');
					const dd = String(hoy.getDate()).padStart(2, '0');
					return `${yy}-${mm}-${dd}`;
				}

				const fechaInput = document.getElementById('fechaNacimiento');
				const fechaFeedback = document.getElementById('fechaNacimientoFeedback');
				if (fechaInput) {
					const maxFecha = fechaMaximaMenosAnios(4);
					// Asignar atributo max para que el selector de fecha no permita días posteriores
					fechaInput.max = maxFecha;

					// Mensaje de validación personalizado si el usuario introduce una fecha inválida
					fechaInput.addEventListener('input', function () {
						if (this.value && this.value > this.max) {
							this.setCustomValidity('El alumno debe tener al menos 4 años.');
							if (fechaFeedback) { fechaFeedback.textContent = 'El alumno debe tener al menos 4 años.'; fechaFeedback.style.display = 'block'; }
						} else {
							this.setCustomValidity('');
							if (fechaFeedback) { fechaFeedback.style.display = 'none'; }
						}
						// actualizar estado de campos representante al cambiar fecha
						actualizarRepresentante();
					});
				}

				// Fecha de ingreso: permitir cualquier fecha hasta hoy (bloquear solo fechas posteriores)
				const fechaIngresoInput = document.getElementById('fechaIngreso');
				if (fechaIngresoInput) {
					const hoy = hoyString();
					// Establecer solo el atributo max a hoy para evitar fechas futuras
					fechaIngresoInput.max = hoy;
					// Mensaje si el usuario selecciona una fecha futura (por ejemplo editando manualmente)
					fechaIngresoInput.addEventListener('input', function () {
						if (this.value && this.value > this.max) {
							this.setCustomValidity('No se permiten fechas posteriores a la fecha actual.');
						} else {
							this.setCustomValidity('');
						}
					});
				}

				// Campos representante
				const repNombre = document.getElementById('txtNombreRepresentante');
				const repTelefono = document.getElementById('txtTelefonoRepresentante');

				function calcularEdadDesdeFecha(valorFecha) {
					if (!valorFecha) return null;
					const partes = valorFecha.split('-');
					if (partes.length !== 3) return null;
					const año = parseInt(partes[0], 10);
					const mes = parseInt(partes[1], 10) - 1;
					const dia = parseInt(partes[2], 10);
					const fechaNac = new Date(año, mes, dia);
					const hoy = new Date();
					let edad = hoy.getFullYear() - fechaNac.getFullYear();
					const m = hoy.getMonth() - fechaNac.getMonth();
					if (m < 0 || (m === 0 && hoy.getDate() < fechaNac.getDate())) {
						edad--;
					}
					return edad;
				}

				function actualizarRepresentante() {
					const edad = fechaInput ? calcularEdadDesdeFecha(fechaInput.value) : null;
					if (edad === null) {
						// Si no hay fecha, dejamos campos activos (servidor validará si es obligatorio)
						if (repNombre) { repNombre.disabled = false; repNombre.required = true; }
						if (repTelefono) { repTelefono.disabled = false; repTelefono.required = true; }
						return;
					}
					if (edad >= 18) {
						// No necesita representante: deshabilitar y limpiar
						if (repNombre) { repNombre.value = ''; repNombre.classList.remove('is-invalid'); repNombre.disabled = true; repNombre.required = false; }
						if (repTelefono) { repTelefono.value = ''; repTelefono.classList.remove('is-invalid'); repTelefono.disabled = true; repTelefono.required = false; }
					} else {
						// Menor de 18: habilitar y marcar obligatorio
						if (repNombre) { repNombre.disabled = false; repNombre.required = true; }
						if (repTelefono) { repTelefono.disabled = false; repTelefono.required = true; }
					}
				}

				// Ejecutar en carga para casos de edición
				actualizarRepresentante();

				// Validación de cédula en tiempo real (cliente) consultando la API
				const cedulaInput = document.getElementById('txtcedeulaalumno');
				const cedulaFeedback = document.getElementById('cedulaFeedback');
				let cedulasExistentes = null; // cache
				async function cargarCedulas() {
					if (cedulasExistentes !== null) return cedulasExistentes;
					try {
						const resp = await fetch('/api/alumnos');
						if (!resp.ok) return [];
						const data = await resp.json();
						// Obtener la cédula actual del formulario (si existe) para excluirla
						const cedulaActual = (document.getElementById('txtcedeulaalumno') && document.getElementById('txtidAlumno'))
							? (document.getElementById('txtcedeulaalumno').value || '').trim().toLowerCase()
							: '';
						cedulasExistentes = data.map(a => a.alu_cedula ? a.alu_cedula.trim().toLowerCase() : null)
							.filter(Boolean)
							// Excluir la cédula actual del formulario para permitir editar sin cambiarla
							.filter(c => c !== cedulaActual);
						return cedulasExistentes;
					} catch (e) {
						console.error('No se pudo cargar cedulas', e);
						return [];
					}
				}

				if (cedulaInput) {
					cedulaInput.addEventListener('input', async function () {
						// eliminar cualquier caracter que no sea dígito y limitar a 10
						this.value = this.value.replace(/\D/g, '').slice(0, 10);
						const val = this.value ? this.value.trim().toLowerCase() : '';
						if (!val) {
							cedulaFeedback.style.display = 'none';
							this.classList.remove('is-invalid');
							return;
						}
						// si la longitud es menor a 10, mostrar mensaje de longitud
						if (this.value.length < 10) {
							cedulaFeedback.textContent = 'La cédula debe tener 10 dígitos.';
							cedulaFeedback.style.display = 'block';
							this.classList.add('is-invalid');
							return;
						}
						const list = await cargarCedulas();
						if (list.includes(val)) {
							cedulaFeedback.textContent = 'Usuario ya está registrado';
							cedulaFeedback.style.display = 'block';
							this.classList.add('is-invalid');
						} else {
							cedulaFeedback.style.display = 'none';
							this.classList.remove('is-invalid');
						}
					});
				}

				// sanitizar y validar teléfono alumno en tiempo real
				const telAlumnoInput = document.getElementById('txttelefonolumno');
				const telAlumnoFb = document.getElementById('telefonoAlumnoFeedback');
				if (telAlumnoInput) {
					telAlumnoInput.addEventListener('input', function () {
						this.value = this.value.replace(/\D/g, '').slice(0, 10);
						if (this.value.length === 10) {
							telAlumnoFb.style.display = 'none';
							this.classList.remove('is-invalid');
						} else {
							// mostrar pero no forzar hasta submit
							telAlumnoFb.textContent = 'Ingrese un teléfono válido de 10 dígitos.';
							telAlumnoFb.style.display = 'block';
							this.classList.add('is-invalid');
						}
					});
				}

				// sanitizar y validar teléfono representante en tiempo real
				const telRepInput = document.getElementById('txtTelefonoRepresentante');
				const telRepFb = document.getElementById('telefonoRepresentanteFeedback');
				if (telRepInput) {
					telRepInput.addEventListener('input', function () {
						this.value = this.value.replace(/\D/g, '').slice(0, 10);
						if (this.value.length === 10 || this.value.length === 0) {
							// válido si está vacío (no obligatorio) o tiene 10 dígitos
							telRepFb.style.display = 'none';
							this.classList.remove('is-invalid');
						} else {
							telRepFb.textContent = 'Ingrese un teléfono válido de 10 dígitos.';
							telRepFb.style.display = 'block';
							this.classList.add('is-invalid');
						}
					});
				}

				// Validación de formulario (Bootstrap-like) - único handler consolidado
				const forms = document.querySelectorAll('.needs-validation');
				Array.from(forms).forEach(function (form) {
					form.addEventListener('submit', function (event) {
						// Asegurar que las restricciones de cinturones estén actualizadas antes de validar
						ajustarOpcionesCinturon();
						// Limpiar posibles mensajes previos
						if (fechaInput) fechaInput.setCustomValidity('');
						if (fechaIngresoInput) fechaIngresoInput.setCustomValidity('');
						if (cedulaInput) cedulaInput.setCustomValidity('');
						// Reaplicar validaciones personalizadas de fecha si es necesario
						if (fechaInput && fechaInput.value && fechaInput.value > fechaInput.max) {
							fechaInput.setCustomValidity('El alumno debe tener al menos 4 años.');
							if (fechaFeedback) { fechaFeedback.textContent = 'El alumno debe tener al menos 4 años.'; fechaFeedback.style.display = 'block'; }
						}
						if (fechaIngresoInput && fechaIngresoInput.value && fechaIngresoInput.value > fechaIngresoInput.max) {
							fechaIngresoInput.setCustomValidity('No se permiten fechas posteriores a la fecha actual.');
						}
						// Validación de cédula (marcada por el listener de input)
						if (cedulaInput && cedulaInput.value && cedulaInput.classList.contains('is-invalid')) {
							cedulaInput.setCustomValidity('Usuario ya está registrado o cédula inválida');
						}

						// Si la cédula tiene menos de 10 dígitos al enviar, marcar como inválida con mensaje claro
						if (cedulaInput && cedulaInput.value && cedulaInput.value.replace(/\D/g, '').length < 10) {
							cedulaInput.setCustomValidity('La cédula debe tener 10 dígitos.');
							if (cedulaFeedback) { cedulaFeedback.textContent = 'La cédula debe tener 10 dígitos.'; cedulaFeedback.style.display = 'block'; }
						}
						// Validación de teléfonos en submit
						if (telAlumnoInput && telAlumnoInput.value && telAlumnoInput.value.length < 10) {
							telAlumnoInput.setCustomValidity('Ingrese un teléfono válido de 10 dígitos.');
							if (telAlumnoFb) { telAlumnoFb.style.display = 'block'; }
						}
						// Si el representante es obligatorio (cuando repNombre o repTelefono están marcados required), validar su contenido
						if (repNombre && repNombre.required && (!repNombre.value || !repNombre.value.trim())) {
							repNombre.setCustomValidity('Ingrese el nombre del representante.');
							const fb = repNombre.parentElement ? repNombre.parentElement.querySelector('.invalid-feedback') : null;
							if (fb) { fb.textContent = 'Ingrese el nombre del representante.'; fb.style.display = 'block'; }
						}
						if (repTelefono && repTelefono.required) {
							if (!repTelefono.value || repTelefono.value.length === 0) {
								repTelefono.setCustomValidity('Ingrese el teléfono del representante.');
								if (telRepFb) { telRepFb.textContent = 'Ingrese el teléfono del representante.'; telRepFb.style.display = 'block'; }
							} else if (repTelefono.value && repTelefono.value.length < 10) {
								repTelefono.setCustomValidity('El teléfono del representante debe tener 10 dígitos.');
								if (telRepFb) { telRepFb.textContent = 'El teléfono del representante debe tener 10 dígitos.'; telRepFb.style.display = 'block'; }
							}
						}
						// Si la validación del select de cinturones puso un mensaje, evitar submit
						const cinturonFeedback = document.getElementById('cinturonFeedback');
						if (selCinturonActual && selCinturonActual.validationMessage) {
							if (cinturonFeedback) { cinturonFeedback.style.display = 'block'; }
							event.preventDefault();
							event.stopPropagation();
							form.classList.add('was-validated');
							return;
						} else if (cinturonFeedback) {
							cinturonFeedback.style.display = 'none';
						}
						// Validación estándar
						if (!form.checkValidity()) {
							event.preventDefault();
							event.stopPropagation();
							// Añadir clases 'is-invalid' a los campos inválidos para que Bootstrap muestre los mensajes
							const invalids = form.querySelectorAll(':invalid');
							Array.from(invalids).forEach(function (el) {
								el.classList.add('is-invalid');
								// si tiene un hermano .invalid-feedback, asegurarlo visible (Bootstrap lo hace con was-validated, pero garantizamos)
								const fb = el.parentElement ? el.parentElement.querySelector('.invalid-feedback') : null;
								if (fb) fb.style.display = 'block';
							});
						}
						form.classList.add('was-validated');
					}, false);
				});

				// Lógica para limitar las opciones de "Cinturón Actual" en función de "Cinturón de Ingreso"
				const selCinturonIngreso = document.getElementById('cmbCinturonIngreso');
				const selCinturonActual = document.getElementById('cmbCinturonActual');

				function ajustarOpcionesCinturon() {
					if (!selCinturonIngreso || !selCinturonActual) return;
					// Construir el orden de cinturones a partir del select de ingreso (se asume que ambos tienen las mismas opciones en el mismo orden)
					const orden = Array.from(selCinturonIngreso.options).map(o => o.value).filter(v => v !== '');
					const ingresoValor = selCinturonIngreso.value;
					const ingresoPos = orden.indexOf(ingresoValor);
					for (let i = 0; i < selCinturonActual.options.length; i++) {
						const opt = selCinturonActual.options[i];
						if (!opt.value) {
							// opción vacía (Seleccione...) siempre habilitada
							opt.disabled = false;
							continue;
						}
						const pos = orden.indexOf(opt.value);
						if (ingresoPos === -1) {
							// si no hay selección de ingreso, habilitar todo
							opt.disabled = false;
						} else {
							// habilitar solo las opciones cuyo nivel sea >= ingresoPos
							opt.disabled = (pos < ingresoPos);
						}
					}
				}

				if (selCinturonIngreso) {
					selCinturonIngreso.addEventListener('change', ajustarOpcionesCinturon);
				}
				if (selCinturonActual) {
					selCinturonActual.addEventListener('change', ajustarOpcionesCinturon);
				}
				// Ejecutar en carga (edición) para aplicar restricciones iniciales
				ajustarOpcionesCinturon();
			})();
			</script>
			<!--end::JavaScript-->

		</div>
	</div>


</body>
<!--end::Body-->
</html>
