<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="/plantilla/plantillaui.html">
<head>
<title>Nuevo Alumno</title>
</head>

<!--begin::Body-->
<body>
	<div layout:fragment="contenidopaginas">

		<div class="card card-info card-outline mb-4">
			<!--begin::Header-->
			<div class="card-header">
				<div class="card-title">INGRESAR NUEVO ALUMNO</div>
			</div>
			<!--end::Header-->

			<!--begin::Form-->
			<form th:action="@{/alumnos}" th:object="${modelAlumno}"
				method="post" class="needs-validation" novalidate>
				<!--begin::Body-->
				<div class="card-body">
					<!-- Mensaje de error proveniente del servidor -->
					<div th:if="${fechaError}" class="alert alert-danger"
						th:text="${fechaError}"></div>
					<!--begin::Row-->
					<div class="row g-3">
					
							<input type="hidden" class="form-control" id="txtidAlumno"
								th:field="*{alu_id}"/>

						<!-- Nombres (ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom01" class="form-label">Nombres:*</label>
							<input type="text" class="form-control" id="txtnombrealumno"
								th:field="*{alu_nombre}" required />
						</div>

						<!-- Apellidos (ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Apellidos:*</label>
							<input type="text" class="form-control" id="txtapellidoalumno"
								required th:field="*{alu_apellido}" />
						</div>

						<!-- cedeula (ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Cedula:*</label>
							<input type="text" class="form-control" id="txtcedeulaalumno"
								th:field="*{alu_cedula}" maxlength="10" minlength="10"
								pattern="[0-9]{10}" required />
							<!-- Mensaje de error de cédula (server-side) -->
							<div th:if="${cedulaError}" class="invalid-feedback d-block"
								th:text="${cedulaError}"></div>
							<!-- Mensaje de validación cliente -->
							<div id="cedulaFeedback" class="invalid-feedback"
								style="display: none"></div>
						</div>

						<!--  email(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Email:*</label>
							<input type="email" class="form-control" id="txtemailalumno"
								th:field="*{alu_email}" placeholder="correo@ejemplo.com"
								required />
						</div>

						<!--  direccion(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Domicilio:*</label>
							<input type="text" class="form-control" id="txtdireccionalumno"
								th:field="*{alu_direccion}" required />
						</div>

						<!--  telefono(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Teléfono:*</label>
							<input type="text" class="form-control" id="txttelefonolumno"
								pattern="[0-9]{10}" th:field="*{alu_telefono}" required />
						</div>


						<!--  nacimiento(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Fecha
								de Nacimiento:*</label> <input type="date" class="form-control"
								id="fechaNacimiento" th:field="*{alu_fecha_nacimiento}" required />

						</div>


						<!--  ingreso(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Fecha
								de Ingreso:*</label> <input type="date" class="form-control"
								id="fechaIngreso" th:field="*{alu_fecha_ingreso}" required />
						</div>


						<!--  nombre representante(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Nombre
								de Representante:</label> <input type="text" class="form-control"
								id="txtNombreRepresentante" th:field="*{alu_nombre_representante}" />
						</div>

						<!--  telefono representante(ejemplo) -->
						<div class="col-md-6">
							<label for="validationCustom02" class="form-label">Telefono
								de Representante:</label> <input type="text" class="form-control"
								id="txtTelefonoRepresentante" th:field="*{alu_telefono_representante}" />
						</div>

						<!-- Mensaje de error del representante (server-side) -->
						<div class="col-12">
							<div th:if="${representanteError}" class="invalid-feedback d-block"
								th:text="${representanteError}"></div>
						</div>

						<!--  nombre representante(ejemplo) -->

						<!-- Cinturon de ingreso -->
						<div class="col-md-6">
							<label for="cmbCinturonIngreso" class="form-label">Cinturón
								de Ingreso:*</label> <select class="form-select" id="cmbCinturonIngreso"
								th:field="*{alu_cinturon_ingreso}" required>

								<option value="">Seleccione...</option>
								<!-- Renderizamos las opciones desde el enum pasado en el modelo -->
								<th:block th:each="cinturon : ${cinturones}">
									<option th:value="${cinturon.name()}"
										th:text="${cinturon.nombre}"></option>
								</th:block>
							</select>
						</div>

						<!-- Cinturon de ingreso -->
						<div class="col-md-6">
							<label for="cmbCinturonActual" class="form-label">Cinturón
								Actual:*</label> <select class="form-select" id="cmbCinturonActual"
								th:field="*{alu_cinturon_actual}" required>

								<option value="">Seleccione...</option>
								<!-- Renderizamos las opciones desde el enum pasado en el modelo -->
								<th:block th:each="cinturon : ${cinturones}">
									<option th:value="${cinturon.name()}"
										th:text="${cinturon.nombre}"></option>
								</th:block>
							</select>
						</div>

						<div class="col-md-6 form-check mt-4">
							<input type="checkbox" class="form-check-input" id="estado"
								th:field="*{alu_estado}" value="A" required> <label
								class="form-check-label" for="estado"> Activo </label>
						</div>
					</div>
					<!--end::Row-->

					<!-- Feedback para validación de cinturones -->
					<div class="col-12">
						<div id="cinturonFeedback" class="invalid-feedback d-block" style="display: none"></div>
					</div>
				</div>
				<!--end::Body-->

				<!--begin::Footer-->
				<div class="card-footer">
					<button type="submit" class="btn btn-primary">Guardar</button>
				</div>
				<!--end::Footer-->
			</form>
			<!--end::Form-->

			<!--begin::JavaScript-->
			<script>
			// Validación: la fecha de nacimiento máxima permitida es hoy - 4 años
			(function () {
				'use strict';
				// Calcula la fecha máxima (YYYY-MM-DD) restando 4 años a la fecha actual
				function fechaMaximaMenosAnios(anios) {
					const hoy = new Date();
					const max = new Date(hoy.getFullYear() - anios, hoy.getMonth(), hoy.getDate());
					const yy = max.getFullYear();
					const mm = String(max.getMonth() + 1).padStart(2, '0');
					const dd = String(max.getDate()).padStart(2, '0');
					return `${yy}-${mm}-${dd}`;
				}

				function hoyString() {
					const hoy = new Date();
					const yy = hoy.getFullYear();
					const mm = String(hoy.getMonth() + 1).padStart(2, '0');
					const dd = String(hoy.getDate()).padStart(2, '0');
					return `${yy}-${mm}-${dd}`;
				}

				const fechaInput = document.getElementById('fechaNacimiento');
				if (fechaInput) {
					const maxFecha = fechaMaximaMenosAnios(4);
					// Asignar atributo max para que el selector de fecha no permita días posteriores
					fechaInput.max = maxFecha;

					// Mensaje de validación personalizado si el usuario introduce una fecha inválida
					fechaInput.addEventListener('input', function () {
						if (this.value && this.value > this.max) {
							this.setCustomValidity('El alumno debe tener al menos 4 años. Seleccione una fecha anterior o igual a ' + this.max + '.');
						} else {
							this.setCustomValidity('');
						}
						// actualizar estado de campos representante al cambiar fecha
						actualizarRepresentante();
					});
				}

				// Fecha de ingreso: permitir cualquier fecha hasta hoy (bloquear solo fechas posteriores)
				const fechaIngresoInput = document.getElementById('fechaIngreso');
				if (fechaIngresoInput) {
					const hoy = hoyString();
					// Establecer solo el atributo max a hoy para evitar fechas futuras
					fechaIngresoInput.max = hoy;
					// Mensaje si el usuario selecciona una fecha futura (por ejemplo editando manualmente)
					fechaIngresoInput.addEventListener('input', function () {
						if (this.value && this.value > this.max) {
							this.setCustomValidity('No se permiten fechas posteriores a la fecha actual.');
						} else {
							this.setCustomValidity('');
						}
					});
				}

				// Campos representante
				const repNombre = document.getElementById('txtNombreRepresentante');
				const repTelefono = document.getElementById('txtTelefonoRepresentante');

				function calcularEdadDesdeFecha(valorFecha) {
					if (!valorFecha) return null;
					const partes = valorFecha.split('-');
					if (partes.length !== 3) return null;
					const año = parseInt(partes[0], 10);
					const mes = parseInt(partes[1], 10) - 1;
					const dia = parseInt(partes[2], 10);
					const fechaNac = new Date(año, mes, dia);
					const hoy = new Date();
					let edad = hoy.getFullYear() - fechaNac.getFullYear();
					const m = hoy.getMonth() - fechaNac.getMonth();
					if (m < 0 || (m === 0 && hoy.getDate() < fechaNac.getDate())) {
						edad--;
					}
					return edad;
				}

				function actualizarRepresentante() {
					const edad = fechaInput ? calcularEdadDesdeFecha(fechaInput.value) : null;
					if (edad === null) {
						// Si no hay fecha, dejamos campos activos (servidor validará si es obligatorio)
						if (repNombre) { repNombre.disabled = false; repNombre.required = true; }
						if (repTelefono) { repTelefono.disabled = false; repTelefono.required = true; }
						return;
					}
					if (edad >= 18) {
						// No necesita representante: deshabilitar y limpiar
						if (repNombre) { repNombre.value = ''; repNombre.classList.remove('is-invalid'); repNombre.disabled = true; repNombre.required = false; }
						if (repTelefono) { repTelefono.value = ''; repTelefono.classList.remove('is-invalid'); repTelefono.disabled = true; repTelefono.required = false; }
					} else {
						// Menor de 18: habilitar y marcar obligatorio
						if (repNombre) { repNombre.disabled = false; repNombre.required = true; }
						if (repTelefono) { repTelefono.disabled = false; repTelefono.required = true; }
					}
				}

				// Ejecutar en carga para casos de edición
				actualizarRepresentante();

				// Validación de cédula en tiempo real (cliente) consultando la API
				const cedulaInput = document.getElementById('txtcedeulaalumno');
				const cedulaFeedback = document.getElementById('cedulaFeedback');
				let cedulasExistentes = null; // cache
				async function cargarCedulas() {
					if (cedulasExistentes !== null) return cedulasExistentes;
					try {
						const resp = await fetch('/api/alumnos');
						if (!resp.ok) return [];
						const data = await resp.json();
						// Obtener la cédula actual del formulario (si existe) para excluirla
						const cedulaActual = (document.getElementById('txtcedeulaalumno') && document.getElementById('txtidAlumno'))
							? (document.getElementById('txtcedeulaalumno').value || '').trim().toLowerCase()
							: '';
						cedulasExistentes = data.map(a => a.alu_cedula ? a.alu_cedula.trim().toLowerCase() : null)
							.filter(Boolean)
							// Excluir la cédula actual del formulario para permitir editar sin cambiarla
							.filter(c => c !== cedulaActual);
						return cedulasExistentes;
					} catch (e) {
						console.error('No se pudo cargar cedulas', e);
						return [];
					}
				}

				if (cedulaInput) {
					cedulaInput.addEventListener('input', async function () {
						const val = this.value ? this.value.trim().toLowerCase() : '';
						if (!val) {
							cedulaFeedback.style.display = 'none';
							this.classList.remove('is-invalid');
							return;
						}
						const list = await cargarCedulas();
						if (list.includes(val)) {
							cedulaFeedback.textContent = 'Usuario ya está registrado';
							cedulaFeedback.style.display = 'block';
							this.classList.add('is-invalid');
						} else {
							cedulaFeedback.style.display = 'none';
							this.classList.remove('is-invalid');
						}
					});
				}

				// Validación de formulario (Bootstrap-like) - único handler consolidado
				const forms = document.querySelectorAll('.needs-validation');
				Array.from(forms).forEach(function (form) {
					form.addEventListener('submit', function (event) {
						// Asegurar que las restricciones de cinturones estén actualizadas antes de validar
						ajustarOpcionesCinturon();
						// Limpiar posibles mensajes previos
						if (fechaInput) fechaInput.setCustomValidity('');
						if (fechaIngresoInput) fechaIngresoInput.setCustomValidity('');
						if (cedulaInput) cedulaInput.setCustomValidity('');
						// Reaplicar validaciones personalizadas de fecha si es necesario
						if (fechaInput && fechaInput.value && fechaInput.value > fechaInput.max) {
							fechaInput.setCustomValidity('El alumno debe tener al menos 4 años.');
						}
						if (fechaIngresoInput && fechaIngresoInput.value && fechaIngresoInput.value > fechaIngresoInput.max) {
							fechaIngresoInput.setCustomValidity('No se permiten fechas posteriores a la fecha actual.');
						}
						// Validación de cédula (marcada por el listener de input)
						if (cedulaInput && cedulaInput.value && cedulaInput.classList.contains('is-invalid')) {
							cedulaInput.setCustomValidity('Usuario ya está registrado');
						}
						// Si la validación del select de cinturones puso un mensaje, evitar submit
						const cinturonFeedback = document.getElementById('cinturonFeedback');
						if (selCinturonActual && selCinturonActual.validationMessage) {
							if (cinturonFeedback) { cinturonFeedback.style.display = 'block'; }
							event.preventDefault();
							event.stopPropagation();
							form.classList.add('was-validated');
							return;
						} else if (cinturonFeedback) {
							cinturonFeedback.style.display = 'none';
						}
						// Validación estándar
						if (!form.checkValidity()) {
							event.preventDefault();
							event.stopPropagation();
						}
						form.classList.add('was-validated');
					}, false);
				});

				// Lógica para limitar las opciones de "Cinturón Actual" en función de "Cinturón de Ingreso"
				const selCinturonIngreso = document.getElementById('cmbCinturonIngreso');
				const selCinturonActual = document.getElementById('cmbCinturonActual');

				function ajustarOpcionesCinturon() {
					if (!selCinturonIngreso || !selCinturonActual) return;
					// Construir el orden de cinturones a partir del select de ingreso (se asume que ambos tienen las mismas opciones en el mismo orden)
					const orden = Array.from(selCinturonIngreso.options).map(o => o.value).filter(v => v !== '');
					const ingresoValor = selCinturonIngreso.value;
					const ingresoPos = orden.indexOf(ingresoValor);
					for (let i = 0; i < selCinturonActual.options.length; i++) {
						const opt = selCinturonActual.options[i];
						if (!opt.value) {
							// opción vacía (Seleccione...) siempre habilitada
							opt.disabled = false;
							continue;
						}
						const pos = orden.indexOf(opt.value);
						if (ingresoPos === -1) {
							// si no hay selección de ingreso, habilitar todo
							opt.disabled = false;
						} else {
							// habilitar solo las opciones cuyo nivel sea >= ingresoPos
							opt.disabled = (pos < ingresoPos);
						}
					}
				}

				if (selCinturonIngreso) {
					selCinturonIngreso.addEventListener('change', ajustarOpcionesCinturon);
				}
				if (selCinturonActual) {
					selCinturonActual.addEventListener('change', ajustarOpcionesCinturon);
				}
				// Ejecutar en carga (edición) para aplicar restricciones iniciales
				ajustarOpcionesCinturon();
			})();
			</script>
			<!--end::JavaScript-->

		</div>
	</div>


</body>
<!--end::Body-->
</html>
