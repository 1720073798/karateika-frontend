<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/plantilla/plantillaui.html">

<head>
    <title>Registro de Asistencias</title>
</head>

<body>

<div layout:fragment="contenidopaginas">

    <div class="card mb-4">

        <div class="card-header">
            <h3 class="card-title">REGISTRO DE ASISTENCIAS</h3>
        </div>

        <div class="card-body">

            <div class="table-responsive" style="max-height: 400px; overflow:auto;">
                <table class="table table-bordered table-striped table-hover align-middle">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th>#</th>
                            <th>Alumno</th>
                            <th>Cédula</th>
                            <th class="text-center">Asiste</th>
                            <th>Observación</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr th:each="alumno : ${alumnoModel}">
                            <td>
                                <span th:text="${alumno.alu_id}"></span>
                                <input type="hidden" class="aluId" th:value="${alumno.alu_id}">
                            </td>
                            <td th:text="${alumno.alu_nombre} + ' ' + ${alumno.alu_apellido}"></td>
                            <td th:text="${alumno.alu_cedula}"></td>
                            <td class="text-center">
                                <input type="checkbox" class="form-check-input chkAsiste">
                            </td>
                            <td>
                                <input type="text" class="form-control txtObservacion"
                                       placeholder="Observación (opcional)">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

  

            <div class="mt-3 text-end">
                <button type="button" id="btnGuardarAsistencias" class="btn btn-primary">
                    Guardar Asistencias
                </button>
            </div>

            <div id="asistenciaStatus" class="mt-3"></div>

        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {

    const btnGuardar = document.getElementById('btnGuardarAsistencias');
    const statusDiv = document.getElementById('asistenciaStatus');

    btnGuardar.addEventListener('click', async () => {

        const rows = document.querySelectorAll('tbody tr');
        const asistencias = [];

        rows.forEach(row => {
            const aluId = row.querySelector('.aluId').value;
            const asiste = row.querySelector('.chkAsiste').checked;
            const obs = row.querySelector('.txtObservacion').value;

            asistencias.push({
                asi_id: 0,
                asi_estado: asiste ? 'Asiste' : 'No Asiste',
                asi_observacion: obs,
                fkalumno: { alu_id: parseInt(aluId) }
            });
        });

        console.log('ENVIANDO:', asistencias);

        try {
            const resp = await fetch('http://localhost:8080/api/asistencias/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(asistencias)
            });

            if (resp.ok) {
            	window.location.href = '/asistencias';
            } else {
                statusDiv.className = 'alert alert-danger';
                statusDiv.textContent = 'Error al guardar: ' + resp.status;
            }

        } catch (e) {
            console.error(e);
            statusDiv.className = 'alert alert-danger';
            statusDiv.textContent = 'Error de conexión';
        }
    });
});
</script>

</div>

</body>
</html>
