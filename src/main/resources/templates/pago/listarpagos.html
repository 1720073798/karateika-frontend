<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="/plantilla/plantillaui.html">

<head>
<title>Listar Pagos</title>
</head>

<body>
	<div layout:fragment="contenidopaginas">

		<div class="card">
			<div class="card-header">
				<h3 class="card-title">Lista de Pagos</h3>
			</div>

			<div class="card-body">

				<!-- Buscador y botón nuevo -->
				<div class="row mb-3">
					<div class="col-md-4">
						<div class="input-group">
							<span class="input-group-text"><i class="bi bi-search"></i></span>
							<input type="text" id="searchInput" class="form-control"
								placeholder="Buscar por alumno..."
								onkeyup="buscarPagos()">
						</div>
					</div>
					
					<div class="col-md-4">
						<div class="input-group">
							<span class="input-group-text"><i class="bi bi-calendar"></i></span>
							<input type="date" id="searchDate" class="form-control"
								onchange="buscarPorFecha()">
						</div>
					</div>

					<div class="col-md-4 text-end">
						<a th:href="@{/pagos/nuevopago}"
							class="btn btn-success"> <i class="bi bi-plus"></i> Nuevo
							Pago
						</a>
					</div>
				</div>

				<!-- Tabla -->
				<div class="table-responsive">
					<table class="table table-striped table-hover">
						<thead class="table-dark">
							<tr>
								<th>ID</th>
								<th>Alumno</th>
								<th>Comprobante</th>
								<th>Monto</th>
								<th>Método</th>
								<th>Fecha Pago</th>
								<th>Registrado por</th>
								<th>Fecha Registro</th>
								<th class="text-center">Acciones</th>
							</tr>
						</thead>

						<tbody id="pagoTableBody">
							<tr th:each="pago : ${listapagos}">
								<td th:text="${pago.pag_id}"></td>

								<td th:text="${pago.fkalumno?.alu_nombre} + ' ' + ${pago.fkalumno?.alu_apellido} ?: '—'"></td>

								<td th:text="${pago.fkcomprobante?.com_numero} ?: '—'"></td>

								<td><span class="badge bg-success">
										$<span th:text="${#numbers.formatDecimal(pago.pag_monto, 1, 2)}"></span>
								</span></td>

								<td th:text="${pago.pag_metodo_pago}"></td>

								<td th:text="${#temporals.format(pago.pag_fecha_pago, 'dd/MM/yyyy')}"></td>
								
								<td th:text="${pago.pag_registrado_por}"></td>
								
								<td th:text="${#temporals.format(pago.pag_fecha_registro, 'dd/MM/yyyy')}"></td>

								<td class="text-center"><a
									th:href="@{/pagos/editar/{id}(id=${pago.pag_id})}"
									class="btn btn-sm btn-warning" title="Editar"> <i class="bi bi-pencil-square"></i>
								</a> <a
									th:href="@{/pagos/eliminar/{id}(id=${pago.pag_id})}"
									class="btn btn-sm btn-danger" title="Eliminar"
									onclick="return confirm(
                                       '¿Estás seguro que quieres eliminar este pago?'
                                   );">
										<i class="bi bi-trash"></i>
								</a></td>
							</tr>
						</tbody>

					</table>
				</div>

			</div>
		</div>

	</div>

	<!-- Scripts -->
	<script>
    let currentPage = 1;
    const itemsPerPage = 10;
    let allData = [];
    let filteredData = [];

    document.addEventListener('DOMContentLoaded', () => {
        allData = Array.from(
            document.querySelectorAll('#pagoTableBody tr')
        );
        filteredData = [...allData];
        mostrarPagina(currentPage);
    });

    function buscarPagos() {
        const searchTerm = document
            .getElementById('searchInput')
            .value
            .toLowerCase();
        const fechaSearch = document.getElementById('searchDate').value;

        filteredData = allData.filter(row => {
            const alumno = row.cells[1].textContent.toLowerCase();
            const fechaPago = row.cells[5].textContent;
            const fechaRegistro = row.cells[7].textContent;
            
            const matchAlumno = alumno.includes(searchTerm);
            const matchFecha = !fechaSearch || 
                              fechaPago.includes(fechaSearch.split('-').reverse().join('/')) ||
                              fechaRegistro.includes(fechaSearch.split('-').reverse().join('/'));
            
            return matchAlumno && matchFecha;
        });

        currentPage = 1;
        mostrarPagina(currentPage);
    }
    
    function buscarPorFecha() {
        buscarPagos();
    }

    function limpiarBusqueda() {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchDate').value = '';
        buscarPagos();
    }

    function mostrarPagina(page) {
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;

        allData.forEach(row => row.style.display = 'none');
        filteredData
            .slice(start, end)
            .forEach(row => row.style.display = '');
    }
</script>

</body>
</html>