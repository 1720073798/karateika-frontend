<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/plantilla/plantillaui.html">
<head>
    <title>Comprobante</title>
</head>
<body>
<div layout:fragment="contenidopaginas">

    <div class="card card-info card-outline mb-4">
        <!--begin::Header-->
        <div class="card-header">
            <div class="card-title">INGRESAR NUEVO COMPROBANTE</div>
        </div>
        <!--end::Header-->

        <!--begin::Form-->
        <form th:action="@{/comprobantes}" th:object="${comprobante}"
              method="post" class="needs-validation" novalidate enctype="multipart/form-data">
            <!--begin::Body-->
            <div class="card-body">
                <!-- Mensaje de error general del servidor -->
                <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

                <!-- ID oculto -->
                <input type="hidden" class="form-control" id="txtidComprobante"
                       th:field="*{com_id}" />

                <!--begin::Row-->
                <div class="row g-3">
                    <!-- Número de Comprobante -->
                    <div class="col-md-6">
                        <label for="comNumero" class="form-label">Número de Comprobante <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="comNumero"
                               th:field="*{com_numero}" min="1" required
                               th:classappend="${com_numero_error} ? ' is-invalid' : ''" />
                        <div id="numeroFeedback" class="invalid-feedback" style="display: none;" th:if="${#strings.isEmpty(com_numero_error)}">
                            Por favor ingrese un número válido (mayor a 0)
                        </div>
                        <!-- Backend-side error -->
                        <div th:if="${com_numero_error}" class="invalid-feedback" th:text="${com_numero_error}" style="display:block;"></div>
                    </div>

                    <!-- Fecha de Subida -->
                    <div class="col-md-6">
                        <label for="comFechaSubida" class="form-label">Fecha de Subida <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="comFechaSubida"
                               th:field="*{com_fecha_subida}" required
                               th:classappend="${com_fecha_error} ? ' is-invalid' : ''" />
                        <div id="fechaFeedback" class="invalid-feedback" style="display: none;" th:if="${#strings.isEmpty(com_fecha_error)}">
                            Por favor seleccione una fecha válida
                        </div>
                        <!-- Backend-side date error -->
                        <div th:if="${com_fecha_error}" class="invalid-feedback" th:text="${com_fecha_error}" style="display:block;"></div>
                    </div>

                    <!-- Archivo Adjunto -->
                    <div class="col-12">
                        <label for="archivo" class="form-label">Archivo Adjunto (PDF o Imagen)</label>
                        <input type="file" class="form-control" id="archivo"
                               name="archivo" accept=".pdf,.jpg,.jpeg,.png,.gif"
                               th:classappend="${com_archivo_error} ? ' is-invalid' : ''" />
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> Formatos permitidos: PDF, JPG, PNG. Tamaño máximo: 5MB
                        </div>
                        <div id="archivoFeedback" class="invalid-feedback" style="display: none;">
                            El archivo no es válido o excede el tamaño permitido
                        </div>
                        <!-- Backend-side file error -->
                        <div th:if="${com_archivo_error}" class="invalid-feedback" th:text="${com_archivo_error}" style="display:block;"></div>
                    </div>
                </div>
                <!--end::Row-->
            </div>
            <!--end::Body-->

            <!--begin::Footer-->
            <div class="card-footer">
                <button type="submit" class="btn btn-primary">Guardar Comprobante</button>
                <a th:href="@{/comprobantes/listarcomprobante}" class="btn btn-secondary ms-2">Cancelar</a>
            </div>
            <!--end::Footer-->
        </form>
        <!--end::Form-->
    </div>
</div>

<!--begin::JavaScript-->
<script>
(function () {
    'use strict';

    const form = document.querySelector('.needs-validation');
    if (!form) return;

    // Campos
    const numeroInput = document.getElementById('comNumero');
    const fechaInput = document.getElementById('comFechaSubida');
    const archivoInput = document.getElementById('archivo');
    const numeroFeedback = document.getElementById('numeroFeedback');
    const fechaFeedback = document.getElementById('fechaFeedback');
    const archivoFeedback = document.getElementById('archivoFeedback');

    // Validación en tiempo real del número
    if (numeroInput) {
        numeroInput.addEventListener('input', function () {
            const val = this.value.trim();
            if (!val || isNaN(val) || parseInt(val) <= 0) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
                numeroFeedback.style.display = 'block';
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
                numeroFeedback.style.display = 'none';
            }
        });
    }

    // Validación de fecha (máximo hoy)
    if (fechaInput) {
        const hoy = new Date();
        const yy = hoy.getFullYear();
        const mm = String(hoy.getMonth() + 1).padStart(2, '0');
        const dd = String(hoy.getDate()).padStart(2, '0');
        fechaInput.max = `${yy}-${mm}-${dd}`;

        fechaInput.addEventListener('input', function () {
            if (!this.value) {
                this.classList.add('is-invalid');
                fechaFeedback.style.display = 'block';
            } else if (this.value > this.max) {
                this.classList.add('is-invalid');
                fechaFeedback.textContent = 'La fecha no puede ser posterior a hoy.';
                fechaFeedback.style.display = 'block';
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
                fechaFeedback.style.display = 'none';
            }
        });
    }

    // Validación del archivo
    if (archivoInput) {
        archivoInput.addEventListener('change', function () {
            const file = this.files[0];
            if (!file) {
                this.classList.remove('is-invalid', 'is-valid');
                archivoFeedback.style.display = 'none';
                return;
            }

            const tiposValidos = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            const tamanoMax = 5 * 1024 * 1024; // 5MB

            if (!tiposValidos.includes(file.type) || file.size > tamanoMax) {
                this.classList.add('is-invalid');
                archivoFeedback.textContent = 
                    !tiposValidos.includes(file.type) ? 
                        'Solo se permiten PDF o imágenes (JPG, PNG, GIF)' :
                        'El archivo excede el tamaño máximo (5MB)';
                archivoFeedback.style.display = 'block';
            } else {
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
                archivoFeedback.style.display = 'none';
            }
        });
    }

    // Submit handler
    form.addEventListener('submit', function (event) {
        let isValid = true;

        // Validar número
        if (numeroInput) {
            const val = numeroInput.value.trim();
            if (!val || isNaN(val) || parseInt(val) <= 0) {
                numeroInput.classList.add('is-invalid');
                numeroFeedback.textContent = 'El numero debe ser mayor a 0.';
                numeroFeedback.style.display = 'block';
                isValid = false;
            } else {
                numeroInput.classList.remove('is-invalid');
                numeroFeedback.style.display = 'none';
            }
        }

        // Validar fecha
        if (fechaInput) {
            if (!fechaInput.value) {
                fechaInput.classList.add('is-invalid');
                fechaFeedback.style.display = 'block';
                isValid = false;
            } else if (fechaInput.value > fechaInput.max) {
                fechaInput.classList.add('is-invalid');
                fechaFeedback.textContent = 'La fecha no puede ser posterior a hoy.';
                fechaFeedback.style.display = 'block';
                isValid = false;
            } else {
                fechaInput.classList.remove('is-invalid');
                fechaFeedback.style.display = 'none';
            }
        }

        // Validar archivo (si existe)
        if (!archivoInput || !archivoInput.files || !archivoInput.files[0]) {
            // If server-side already attached an error, keep it; otherwise show client message
            if (archivoFeedback) {
                archivoFeedback.textContent = 'Debe subir archivo de respaldo';
                archivoFeedback.style.display = 'block';
            }
            if (archivoInput) archivoInput.classList.add('is-invalid');
            isValid = false;
        } else {
            const file = archivoInput.files[0];
            const tiposValidos = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            const tamanoMax = 5 * 1024 * 1024;
            if (!tiposValidos.includes(file.type) || file.size > tamanoMax) {
                archivoInput.classList.add('is-invalid');
                isValid = false;
            } else {
                archivoInput.classList.remove('is-invalid');
            }
        }

        if (!isValid) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
})();
</script>
<!--end::JavaScript-->

</body>
</html>