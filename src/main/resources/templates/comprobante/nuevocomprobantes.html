<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="/plantilla/plantillaui.html">
<head>
<title>Comprobante</title>
</head>
<body>
	<div layout:fragment="contenidopaginas">
		<div class="card card-info card-outline mb-4">
			<div class="card-header">
				<div class="card-title">
					<i class="bi bi-file-earmark-plus"></i> <span
						th:text="${comprobante.com_id == 0 ? 'NUEVO COMPROBANTE' : 'EDITAR COMPROBANTE'}"></span>
				</div>
			</div>

			<form class="needs-validation" novalidate
				th:action="@{/comprobantes}" th:object="${comprobante}"
				method="post" enctype="multipart/form-data">
				<div class="card-body">
					<!-- ID oculto para saber si es edición -->
					<input type="hidden" th:field="*{com_id}" />

					<div class="row g-3">
						<!-- Número de Comprobante -->
						<div class="col-md-6">
							<label for="comNumero" class="form-label"> <i
								class="bi bi-hash"></i> Número de Comprobante <span
								class="text-danger">*</span>
							</label> <input type="number" class="form-control" id="comNumero"
								th:field="*{com_numero}" min="1" required />
							<div class="invalid-feedback">Por favor ingrese un número
								de comprobante válido</div>
							<small class="text-muted">Ejemplo: 2026001, 2026002</small>
						</div>

						<!-- Fecha de Subida -->
						<div class="col-md-6">
							<label for="comFechaSubida" class="form-label"> <i
								class="bi bi-calendar"></i> Fecha de Subida <span
								class="text-danger">*</span>
							</label> <input type="date" class="form-control" id="comFechaSubida"
								th:field="*{com_fecha_subida}" required />
							<div class="invalid-feedback">Por favor seleccione una
								fecha válida</div>
						</div>

						<!-- Archivo Adjunto -->
						<div class="col-12">
							<label for="archivo" class="form-label"> <i
								class="bi bi-paperclip"></i> Archivo Adjunto (PDF o Imagen)
							</label> <input type="file" class="form-control" id="archivo"
								name="archivo" accept=".pdf,.jpg,.jpeg,.png,.gif"
								onchange="validarArchivo(this)" />
							<div class="form-text">
								<i class="bi bi-info-circle"></i> Formatos permitidos: PDF, JPG,
								PNG. Tamaño máximo: 5MB
							</div>
							<div id="archivoError" class="text-danger mt-1"
								style="display: none;"></div>

							<!-- Mostrar archivo actual si es edición -->
							<div
								th:if="${comprobante.com_id != 0 && comprobante.com_ruta_archivo != null && !comprobante.com_ruta_archivo.isEmpty()}"
								class="mt-2">
								<small class="text-muted"> <i class="bi bi-file-earmark"></i>
									Archivo actual: <span th:text="${comprobante.com_ruta_archivo}"></span>
									(déjalo en blanco para mantenerlo)
								</small>
							</div>
						</div>
					</div>
				</div>

				<div class="card-footer">
					<button class="btn btn-info" type="submit">
						<i class="bi bi-save"></i> <span
							th:text="${comprobante.com_id == 0 ? 'Guardar Comprobante' : 'Actualizar Comprobante'}"></span>
					</button>
					<a th:href="@{/comprobantes/listarcomprobante}"
						class="btn btn-secondary ms-2"> <i class="bi bi-x"></i>
						Cancelar
					</a>
				</div>
			</form>
		</div>
	</div>

	<script>
// Validación del formulario
(() => {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
})();

// Validación del archivo
function validarArchivo(input) {
    const archivo = input.files[0];
    const errorDiv = document.getElementById('archivoError');
    
    if (archivo) {
        // Validar tipo de archivo
        const tipo = archivo.type;
        const tiposPermitidos = [
            'application/pdf',
            'image/jpeg',
            'image/jpg',
            'image/png',
            'image/gif'
        ];
        
        if (!tiposPermitidos.includes(tipo)) {
            errorDiv.textContent = 'Solo se permiten archivos PDF o imágenes (JPG, PNG, GIF)';
            errorDiv.style.display = 'block';
            input.value = '';
            return false;
        }
        
        // Validar tamaño (5MB)
        if (archivo.size > 5 * 1024 * 1024) {
            errorDiv.textContent = 'El archivo no puede exceder 5MB de tamaño';
            errorDiv.style.display = 'block';
            input.value = '';
            return false;
        }
        
        errorDiv.style.display = 'none';
    }
    
    return true;
}
</script>
</body>
</html>